<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <title>Location Picker</title>
  <style>
    /* 1. Map fills the screen, No Scrollbars */
    html, body { 
      height: 100%; 
      margin: 0; 
      padding: 0; 
      overflow: hidden; 
      font-family: 'Segoe UI', Arial, sans-serif; 
    }
    
    #map { 
      height: 100%; 
      width: 100%; 
    }

    /* 2. Search Bar Styling */
    #pac-input {
      display: none; /* ✅ CHANGED: Removed !important so JS can show it later */
      background-color: #fff;
      font-family: 'Segoe UI', Tahoma, sans-serif;
      font-size: 15px;
      font-weight: 400;
      margin: 10px; 
      padding: 0 13px;
      width: 320px;
      height: 40px;
      border: 1px solid #dadce0;
      border-radius: 4px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.3);
      outline: none;
      direction: rtl; /* Arabic Support */
    }
    
    #pac-input:focus {
      border-color: #4285f4;
    }
  </style>

  <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCYaJ4Gjq36mq8swYgjNXOYr5mKZi45niA&libraries=marker,places,geocoding&callback=initPickerMap&loading=async&v=weekly" async defer></script>
</head>
<body>

  <input id="pac-input" type="text" placeholder="ابحث عن موقع (Search Location)..." />

  <div id="map"></div>

  <script>
    // --- Globals ---
    let map, marker, geocoder, autocomplete;

    window.initPickerMap = async function() {
      try {
        // 1. Load Libraries
        await google.maps.importLibrary("maps");
        await google.maps.importLibrary("marker");
        await google.maps.importLibrary("places");
        await google.maps.importLibrary("geocoding");

        geocoder = new google.maps.Geocoder();
        
        // ✅ Default: School Location (Jordan)
        const defaultPos = { lat: 32.028031, lng: 35.704308 };

        // 2. Initialize Map
        map = new google.maps.Map(document.getElementById("map"), {
          center: defaultPos,
          zoom: 15,
          mapId: "48c2bb983bd19c1c44d95cb7", // Required for Advanced Markers
          
          // ✅ LAYOUT: Satellite on Right
          mapTypeControl: true, 
          mapTypeControlOptions: {
              style: google.maps.MapTypeControlStyle.HORIZONTAL_BAR,
              position: google.maps.ControlPosition.TOP_RIGHT
          },
          streetViewControl: false,
          fullscreenControl: false
        });

        // 3. Initialize Marker (Draggable)
        marker = new google.maps.marker.AdvancedMarkerElement({
          map: map,
          position: defaultPos,
          gmpDraggable: true
        });

        // 4. SETUP SEARCH
        const input = document.getElementById("pac-input");
        
        // Push Search Bar to Top Left (Still hidden)
        map.controls[google.maps.ControlPosition.TOP_LEFT].push(input);

        // ✅ FIX: Reveal Search Box ONLY after map tiles load
        google.maps.event.addListenerOnce(map, 'tilesloaded', () => {
           input.style.display = "block"; 
        });

        // Connect logic
        autocomplete = new google.maps.places.Autocomplete(input);
        autocomplete.bindTo("bounds", map);

        // 5. SEARCH LISTENER
        autocomplete.addListener("place_changed", () => {
          const place = autocomplete.getPlace();

          if (!place.geometry || !place.geometry.location) {
            window.alert("No details available for input: '" + place.name + "'");
            return;
          }

          // A. Move Map
          if (place.geometry.viewport) {
            map.fitBounds(place.geometry.viewport);
          } else {
            map.setCenter(place.geometry.location);
            map.setZoom(17);
          }

          // B. Move Marker
          marker.position = place.geometry.location;

          // C. Send Data
          updateFromMarker(); // Using helper ensures consistency
        });

        // 6. DRAG LISTENER
        marker.addListener("dragend", () => {
          updateFromMarker();
        });

        // 7. CLICK LISTENER
        map.addListener("click", (e) => {
          marker.position = e.latLng;
          updateFromMarker();
        });

        console.log("✅ Picker Map Initialized");

      } catch (e) {
        console.error("❌ Map Initialization Failed:", e);
      }
    };

    // Helper: Update Search Text & App Data
    function updateFromMarker() {
      const pos = marker.position;
      
      // Handle both LatLng object and LatLngLiteral
      const lat = (typeof pos.lat === 'function') ? pos.lat() : pos.lat;
      const lng = (typeof pos.lng === 'function') ? pos.lng() : pos.lng;
      
      sendToFlutter(lat, lng);
      
      // Update Search Bar Text with Address
      if (geocoder) {
          geocoder.geocode({ location: {lat, lng} }, (results, status) => {
            if (status === "OK" && results[0]) {
                const input = document.getElementById("pac-input");
                if (input) {
                    input.value = results[0].formatted_address;
                }
            }
          });
      }
    }

    // Send Data to App
    function sendToFlutter(lat, lng) {
      const data = { action: "locationPicked", lat: lat, lng: lng };
      
      // Web / Windows WebView Support
      if (window.FlutterChan) {
          window.FlutterChan.postMessage(JSON.stringify(data));
      } else {
          window.parent.postMessage(data, "*");
      }
    }

    // Initial Position Handler (If editing an existing location)
    window.addEventListener("message", (event) => {
      let data = event.data;
      if (typeof data === 'string') {
        try { data = JSON.parse(data); } catch(e) {}
      }

      if (data && data.action === "setInitialPos") {
        const lat = parseFloat(data.lat);
        const lng = parseFloat(data.lng);
        
        if (!isNaN(lat) && !isNaN(lng)) {
             const pos = { lat, lng };
             
             // Retry loop to ensure map is ready before setting position
             const i = setInterval(() => {
                 if (map && marker) {
                     clearInterval(i);
                     map.setCenter(pos);
                     marker.position = pos;
                     map.setZoom(17);
                     updateFromMarker(); // Update text address immediately
                 }
             }, 100);
        }
      }
    });
  </script>
</body>
</html>
