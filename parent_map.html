<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <title>Parent Tracking Map</title>
  <style>
    html, body, #map { height: 100%; margin: 0; padding: 0; font-family: 'Segoe UI', sans-serif; }
    
    /* REMOVED CSS TRANSITION - We use JS Animation now for real smoothness */
    .bus-marker-container {
      pointer-events: none;
    }

    /* üéØ RECENTER BUTTON CSS */
    .custom-map-control {
      background-color: #fff;
      border: 0;
      border-radius: 8px;
      box-shadow: 0 2px 6px rgba(0,0,0,.3);
      cursor: pointer;
      margin: 10px;
      padding: 8px 12px;
      font-size: 14px;
      font-weight: bold;
      color: #1a73e8;
      display: flex;
      align-items: center;
      gap: 5px;
    }
    .custom-map-control:hover { background-color: #f8f9fa; }
  </style>
</head>
<body>

  <div id="map"></div>

  <script>
    let map;
    let busMarker;
    let studentMarkers = {};
    let isMapInit = false;
    let AdvancedMarkerElement, PinElement;
    
    // Animation Variables
    let animationFrameId = null; 
    let isUserPanned = false;

    // --- 1. INITIALIZATION ---
    async function initMap() {
      try {
        const { Map } = await google.maps.importLibrary("maps");
        const markerLib = await google.maps.importLibrary("marker");
        AdvancedMarkerElement = markerLib.AdvancedMarkerElement;
        PinElement = markerLib.PinElement;

        map = new Map(document.getElementById("map"), {
          center: { lat: 33.8938, lng: 35.5018 },
          zoom: 15,
          mapId: "48c2bb983bd19c1c44d95cb7",
          disableDefaultUI: false, 
          mapTypeControl: true,
          zoomControl: true,
          streetViewControl: false,
          fullscreenControl: false
        });

        // ‚úÖ RECENTER BUTTON
        const recenterBtn = document.createElement("button");
        recenterBtn.innerHTML = "üéØ ÿ•ÿπÿßÿØÿ© ÿ∂ÿ®ÿ∑ ÿßŸÑÿπÿ±ÿ∂";
        recenterBtn.classList.add("custom-map-control");
        recenterBtn.addEventListener("click", () => {
          isUserPanned = false;
          recenterView();
        });

        map.controls[google.maps.ControlPosition.RIGHT_BOTTOM].push(recenterBtn);

        // Detect dragging
        map.addListener("dragstart", () => { isUserPanned = true; });

        isMapInit = true;
        console.log("‚úÖ Parent Map Ready");

        // üî• Tell Flutter we are ready
        const readyPayload = { action: "mapIsReady" };
        if (window.chrome && window.chrome.webview) {
            window.chrome.webview.postMessage(readyPayload);
        } else if (window.parent) {
            window.parent.postMessage(readyPayload, "*");
        }

      } catch (e) {
        console.error("‚ùå Init Error: ", e);
      }
    }

    // --- 2. SMOOTH ANIMATION LOGIC ---
    function animateMarker(marker, targetLat, targetLng) {
      // Get start position (handle both object and literal formats)
      const startPos = marker.position;
      const startLat = (typeof startPos.lat === 'function') ? startPos.lat() : startPos.lat;
      const startLng = (typeof startPos.lng === 'function') ? startPos.lng() : startPos.lng;

      const startTime = performance.now();
      const duration = 2000; // Slide over 2 seconds (matches typical update speed)

      // Cancel any existing animation to prevent conflict
      if (animationFrameId) cancelAnimationFrame(animationFrameId);

      function step(currentTime) {
        const elapsed = currentTime - startTime;
        const progress = Math.min(elapsed / duration, 1);

        // Calculate intermediate position
        const currentLat = startLat + (targetLat - startLat) * progress;
        const currentLng = startLng + (targetLng - startLng) * progress;

        // Move marker
        marker.position = { lat: currentLat, lng: currentLng };

        // Continue if not finished
        if (progress < 1) {
          animationFrameId = requestAnimationFrame(step);
        } else {
          animationFrameId = null;
        }
      }

      animationFrameId = requestAnimationFrame(step);
    }

    // --- 3. RECENTER LOGIC ---
    function recenterView() {
      if (!isMapInit || !map) return;
      
      const bounds = new google.maps.LatLngBounds();
      let hasPoints = false;

      if (busMarker && busMarker.position) {
        bounds.extend(busMarker.position);
        hasPoints = true;
      }

      Object.values(studentMarkers).forEach(m => {
        if (m.position) {
          bounds.extend(m.position);
          hasPoints = true;
        }
      });

      if (hasPoints) {
        setTimeout(() => {
          map.fitBounds(bounds, { top: 50, bottom: 50, left: 50, right: 50 });
          // Prevent zoom becoming too close
          const listener = google.maps.event.addListener(map, 'idle', () => {
            if (map.getZoom() > 17) map.setZoom(17);
            google.maps.event.removeListener(listener);
          });
        }, 100);
      }
    }

    // --- 4. BRIDGE FUNCTION ---
    window.handleDirectUpdate = function(lat, lng) {
      updateBusUI({ lat: lat, lng: lng });
    };

    // --- 5. UI UPDATE LOGIC ---
    function updateBusUI(data) {
      if (!isMapInit) return;
      
      const lat = parseFloat(data.lat);
      const lng = parseFloat(data.lng);
      if (isNaN(lat) || isNaN(lng)) return;
      
      const busPos = { lat, lng };

      if (!busMarker) {
        // Create marker instantly if it doesn't exist
        const busPin = new PinElement({ background: "#FBBC04", glyphText: "üöå" });
        const container = document.createElement('div');
        container.className = 'bus-marker-container';
        container.appendChild(busPin.element);

        busMarker = new AdvancedMarkerElement({
          map: map,
          position: busPos,
          content: container,
          zIndex: 1000
        });
      } else {
        // üî• ANIMATE to new position instead of jumping
        animateMarker(busMarker, lat, lng);
      }

      if (!isUserPanned) {
        recenterView();
      }
    }

    // --- 6. MESSAGE LISTENERS ---
    window.addEventListener("message", async (event) => {
      const data = event.data;
      if (!data || !isMapInit) return;

      if (data.action === "initParentMap") {
        const myMarkers = data.myMarkers || [];
        myMarkers.forEach(m => {
          const pos = { lat: parseFloat(m.lat), lng: parseFloat(m.lng) };
          if (!studentMarkers[m.id]) {
            const pin = new PinElement({ background: "#00c853", glyphColor: "white" });
            studentMarkers[m.id] = new AdvancedMarkerElement({
              map: map,
              position: pos,
              content: pin.element,
              title: m.name
            });
          }
        });
        recenterView();
      }

      if (data.action === "updateBusLocation") {
        updateBusUI(data);
      }
    });
  </script>

  <script 
    src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCYaJ4Gjq36mq8swYgjNXOYr5mKZi45niA&libraries=marker,geometry&v=weekly&loading=async&callback=initMap" 
    async defer>
  </script>
</body>
</html>
