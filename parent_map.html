<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <title>Parent Map</title>

  <style>
    html, body {
      height: 100%;
      margin: 0;
      padding: 0;
      overflow: hidden;
      font-family: 'Segoe UI', Tahoma, sans-serif;
    }
    #map { height: 100%; width: 100%; }
  </style>

  <script
    src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCYaJ4Gjq36mq8swYgjNXOYr5mKZi45niA&callback=initMap&libraries=marker,geometry&loading=async&v=weekly"
    async defer>
  </script>
</head>

<body>
  <div id="map"></div>

  <script>
    // --- Configuration ---
    const BUS_ICON_URL = "https://raedapplebanon-spec.github.io/route-map/school-bus_6122028.png";
    const CHILD_ICON_COLOR = "#00c853";

    // --- State ---
    let map;
    let busMarker = null;
    let childMarkers = [];
    let myStopsData = [];

    // ✅ FIX: Fit separately for students first, then once again when bus first appears
    let didFitStudents = false;
    let didFitBus = false;

    // ✅ FIX: if bus updates arrive before map is ready
    let pendingBus = null;

    // Animation
    let animationFrameId = null;
    let animationStartTime = 0;
    const ANIMATION_DURATION = 1000;

    // --- Initialize Map ---
    window.initMap = async function() {
      const { Map } = await google.maps.importLibrary("maps");
      await google.maps.importLibrary("marker");

      map = new Map(document.getElementById("map"), {
        center: { lat: 33.8938, lng: 35.5018 },
        zoom: 12,
        mapId: "48c2bb983bd19c1c44d95cb7",
        mapTypeControl: false,
        streetViewControl: false,
        fullscreenControl: false,
      });

      // If a bus location came early, apply it now
      if (pendingBus) {
        updateBusPosition(pendingBus.lat, pendingBus.lng);
        pendingBus = null;
      }

      sendToFlutter({ action: 'mapIsReady' });
    };

    // --- Message Listener ---
    window.addEventListener("message", function(event) {
      if (!event.data) return;

      let data = event.data;
      if (typeof data === 'string') {
        try { data = JSON.parse(data); } catch (e) {}
      }

      if (data.action === "initParentMap") {
        const myMarkers = data.myMarkers || [];
        myStopsData = myMarkers;

        drawMyChildren(myMarkers);
        fitToStudentsOnce(); // ✅ fit to student markers
      }

      if (data.action === "updateBusLocation") {
        updateBusPosition(data.lat, data.lng);
      }
    });

    // --- Draw Green Pins (multiple students) ---
    async function drawMyChildren(markersData) {
      childMarkers.forEach(m => { m.map = null; });
      childMarkers = [];

      const { AdvancedMarkerElement, PinElement } = await google.maps.importLibrary("marker");

      markersData.forEach(child => {
        const lat = parseFloat(child.lat);
        const lng = parseFloat(child.lng);
        if (!isFinite(lat) || !isFinite(lng)) return;

        const pin = new PinElement({
          background: CHILD_ICON_COLOR,
          borderColor: "#ffffff",
          glyphColor: "#ffffff",
          scale: 1.1
        });

        const marker = new AdvancedMarkerElement({
          map: map,
          position: { lat, lng },
          content: pin.element,
          title: child.name || "موقع الطالب",
        });

        childMarkers.push(marker);
      });
    }

    // --- Bus Animation / Updates ---
    function updateBusPosition(lat, lng) {
      // If map not ready yet, store last bus update
      if (!map || !window.google || !google.maps) {
        pendingBus = { lat, lng };
        return;
      }

      const nLat = parseFloat(lat);
      const nLng = parseFloat(lng);
      if (!isFinite(nLat) || !isFinite(nLng)) return;

      const newPos = new google.maps.LatLng(nLat, nLng);

      // First time: create marker, then fit once to include bus + students
      if (!busMarker) {
        busMarker = new google.maps.Marker({
          map: map,
          position: newPos,
          icon: {
            url: BUS_ICON_URL,
            scaledSize: new google.maps.Size(45, 45),
            anchor: new google.maps.Point(22.5, 22.5),
          },
          zIndex: 1000
        });

        fitToStudentsAndBusOnce(); // ✅ ensure bus becomes visible
        return;
      }

      if (animationFrameId) cancelAnimationFrame(animationFrameId);
      const startPos = busMarker.getPosition();
      animateMarker(startPos, newPos);
    }

    function animateMarker(startLatLng, targetLatLng) {
      animationStartTime = Date.now();

      function step() {
        const elapsed = Date.now() - animationStartTime;
        const progress = Math.min(elapsed / ANIMATION_DURATION, 1);

        const currentLat = startLatLng.lat() + (targetLatLng.lat() - startLatLng.lat()) * progress;
        const currentLng = startLatLng.lng() + (targetLatLng.lng() - startLatLng.lng()) * progress;

        busMarker.setPosition(new google.maps.LatLng(currentLat, currentLng));

        if (progress < 1) {
          animationFrameId = requestAnimationFrame(step);
        }
      }
      step();
    }

    // --- Fit map to students once (so markers show immediately) ---
    function fitToStudentsOnce() {
      if (didFitStudents || !map) return;

      const bounds = new google.maps.LatLngBounds();
      let hasAny = false;

      (myStopsData || []).forEach(m => {
        const lat = parseFloat(m.lat);
        const lng = parseFloat(m.lng);
        if (isFinite(lat) && isFinite(lng)) {
          bounds.extend(new google.maps.LatLng(lat, lng));
          hasAny = true;
        }
      });

      if (hasAny) {
        map.fitBounds(bounds, 60);
        didFitStudents = true;
      }
    }

    // --- Fit map once more when bus appears, include bus + students ---
    function fitToStudentsAndBusOnce() {
      if (didFitBus || !map || !busMarker) return;

      const bounds = new google.maps.LatLngBounds();
      let hasAny = false;

      (myStopsData || []).forEach(m => {
        const lat = parseFloat(m.lat);
        const lng = parseFloat(m.lng);
        if (isFinite(lat) && isFinite(lng)) {
          bounds.extend(new google.maps.LatLng(lat, lng));
          hasAny = true;
        }
      });

      bounds.extend(busMarker.getPosition());
      hasAny = true;

      if (hasAny) {
        map.fitBounds(bounds, 60);
        didFitBus = true;
      }
    }

    // --- Send to Flutter (web + mobile webview) ---
    function sendToFlutter(payload) {
      if (window.FlutterChan) {
        window.FlutterChan.postMessage(JSON.stringify(payload));
      } else {
        window.parent.postMessage(payload, "*");
      }
    }
  </script>
</body>
</html>
