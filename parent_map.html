<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <title>Parent Tracking Map</title>
  <style>
    html, body, #map { height: 100%; margin: 0; padding: 0; font-family: 'Segoe UI', sans-serif; }
    
    .bus-marker-container { pointer-events: none; }

    /* Style for the Group Marker (when students are close) */
    .group-marker {
      background-color: #1a73e8; /* Google Blue */
      color: white;
      border-radius: 50%;
      width: 30px;
      height: 30px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      border: 2px solid white;
      box-shadow: 0 2px 4px rgba(0,0,0,0.3);
      cursor: pointer;
    }

    /* Style for the Popup List */
    .student-list-popup {
      padding: 5px;
      text-align: right; /* RTL alignment */
    }
    .student-list-popup h4 { margin: 0 0 5px 0; font-size: 14px; color: #333; }
    .student-list-popup ul { margin: 0; padding-right: 20px; }
    .student-list-popup li { font-size: 13px; margin-bottom: 2px; }

    .custom-map-control {
      background-color: #fff;
      border: 0;
      border-radius: 8px;
      box-shadow: 0 2px 6px rgba(0,0,0,.3);
      cursor: pointer;
      margin: 10px;
      padding: 8px 12px;
      font-size: 14px;
      font-weight: bold;
      color: #1a73e8;
      display: flex;
      align-items: center;
      gap: 5px;
    }
    .custom-map-control:hover { background-color: #f8f9fa; }
  </style>
</head>
<body>

  <div id="map"></div>

  <script>
    let map;
    let busMarker;
    let studentMarkers = []; // Changed to array to manage clusters easier
    let infoWindow; // For showing the names
    let isMapInit = false;
    let AdvancedMarkerElement, PinElement;
    
    // Animation Variables
    let animationFrameId = null; 
    let isUserPanned = false;

    // --- 1. INITIALIZATION ---
    async function initMap() {
      try {
        const { Map } = await google.maps.importLibrary("maps");
        const markerLib = await google.maps.importLibrary("marker");
        // Ensure geometry library is loaded for distance calculation
        await google.maps.importLibrary("geometry"); 

        AdvancedMarkerElement = markerLib.AdvancedMarkerElement;
        PinElement = markerLib.PinElement;

        map = new Map(document.getElementById("map"), {
          center: { lat: 33.8938, lng: 35.5018 },
          zoom: 15,
          mapId: "48c2bb983bd19c1c44d95cb7",
          disableDefaultUI: false, 
          mapTypeControl: true,
          zoomControl: true,
          streetViewControl: false,
          fullscreenControl: false
        });

        // Initialize one shared InfoWindow
        infoWindow = new google.maps.InfoWindow();

        // RECENTER BUTTON
        const recenterBtn = document.createElement("button");
        recenterBtn.innerHTML = "ðŸŽ¯ Ø¥Ø¹Ø§Ø¯Ø© Ø¶Ø¨Ø· Ø§Ù„Ø¹Ø±Ø¶";
        recenterBtn.classList.add("custom-map-control");
        recenterBtn.addEventListener("click", () => {
          isUserPanned = false;
          recenterView(true); 
        });

        map.controls[google.maps.ControlPosition.RIGHT_BOTTOM].push(recenterBtn);

        // Detect dragging
        map.addListener("dragstart", () => { isUserPanned = true; });

        isMapInit = true;
        console.log("âœ… Parent Map Ready");

        const readyPayload = { action: "mapIsReady" };
        if (window.chrome && window.chrome.webview) {
            window.chrome.webview.postMessage(readyPayload);
        } else if (window.parent) {
            window.parent.postMessage(readyPayload, "*");
        }

      } catch (e) {
        console.error("âŒ Init Error: ", e);
      }
    }

    // --- 2. CLUSTERING LOGIC ---
    function groupStudents(students) {
      const groups = [];
      const threshold = 20; // 20 meters

      students.forEach(student => {
        let added = false;
        const studentPos = new google.maps.LatLng(parseFloat(student.lat), parseFloat(student.lng));

        // Try to find an existing close group
        for (let group of groups) {
          const groupPos = new google.maps.LatLng(group.lat, group.lng);
          const distance = google.maps.geometry.spherical.computeDistanceBetween(studentPos, groupPos);
          
          if (distance <= threshold) {
            group.members.push(student);
            added = true;
            break;
          }
        }

        // If no close group found, create a new one
        if (!added) {
          groups.push({
            lat: parseFloat(student.lat),
            lng: parseFloat(student.lng),
            members: [student]
          });
        }
      });
      return groups;
    }

    // --- 3. RENDERING MARKERS ---
    function renderStudentMarkers(groups) {
      // Clear old markers
      studentMarkers.forEach(m => m.map = null);
      studentMarkers = [];

      groups.forEach(group => {
        const position = { lat: group.lat, lng: group.lng };
        let markerContent;
        let marker;

        if (group.members.length > 1) {
          // --- MULTIPLE STUDENTS (Blue Circle with Count) ---
          const div = document.createElement("div");
          div.className = "group-marker";
          div.textContent = group.members.length;
          markerContent = div;

          marker = new AdvancedMarkerElement({
            map: map,
            position: position,
            content: markerContent,
            title: "Students Group"
          });

          // Add Click Listener to show names
          marker.addListener("click", () => {
            let listHtml = `<div class="student-list-popup"><h4>Ø§Ù„Ø·Ù„Ø§Ø¨ (${group.members.length})</h4><ul>`;
            group.members.forEach(m => {
              listHtml += `<li>${m.name}</li>`;
            });
            listHtml += `</ul></div>`;
            
            infoWindow.setContent(listHtml);
            infoWindow.open(map, marker);
          });

        } else {
          // --- SINGLE STUDENT (Green Pin) ---
          const pin = new PinElement({ background: "#00c853", glyphColor: "white" });
          markerContent = pin.element;
          
          marker = new AdvancedMarkerElement({
            map: map,
            position: position,
            content: markerContent,
            title: group.members[0].name
          });
        }
        
        studentMarkers.push(marker);
      });
    }

    // --- 4. ANIMATION & UPDATES ---
    function animateMarker(marker, targetLat, targetLng) {
      // ... (Same animation logic as before) ...
      const startPos = marker.position;
      const startLat = (typeof startPos.lat === 'function') ? startPos.lat() : startPos.lat;
      const startLng = (typeof startPos.lng === 'function') ? startPos.lng() : startPos.lng;
      const startTime = performance.now();
      const duration = 2000; 
      if (animationFrameId) cancelAnimationFrame(animationFrameId);
      function step(currentTime) {
        const elapsed = currentTime - startTime;
        const progress = Math.min(elapsed / duration, 1);
        const currentLat = startLat + (targetLat - startLat) * progress;
        const currentLng = startLng + (targetLng - startLng) * progress;
        marker.position = { lat: currentLat, lng: currentLng };
        if (progress < 1) animationFrameId = requestAnimationFrame(step);
        else animationFrameId = null;
      }
      animationFrameId = requestAnimationFrame(step);
    }

    function recenterView(forceFit = false) {
      if (!isMapInit || !map) return;
      const bounds = new google.maps.LatLngBounds();
      let hasPoints = false;

      if (busMarker && busMarker.position) {
        bounds.extend(busMarker.position);
        hasPoints = true;
      }

      // Check the clustered markers
      studentMarkers.forEach(m => {
        if (m.position) {
          bounds.extend(m.position);
          hasPoints = true;
        }
      });

      if (hasPoints && forceFit) {
        map.fitBounds(bounds, { top: 50, bottom: 50, left: 50, right: 50 });
      } else if (busMarker && !isUserPanned) {
        map.panTo(busMarker.position);
      }
    }

    window.handleDirectUpdate = function(lat, lng) {
      updateBusUI({ lat: lat, lng: lng });
    };

    function updateBusUI(data) {
      if (!isMapInit) return;
      const lat = parseFloat(data.lat);
      const lng = parseFloat(data.lng);
      if (isNaN(lat) || isNaN(lng)) return;
      const busPos = { lat, lng };

      if (!busMarker) {
        const busPin = new PinElement({ background: "#FBBC04", glyphText: "ðŸšŒ" });
        const container = document.createElement('div');
        container.className = 'bus-marker-container';
        container.appendChild(busPin.element);
        busMarker = new AdvancedMarkerElement({
          map: map,
          position: busPos,
          content: container,
          zIndex: 1000
        });
      } else {
        animateMarker(busMarker, lat, lng);
      }
      if (!isUserPanned) recenterView(false); 
    }

    // --- 5. MESSAGE LISTENERS ---
    window.addEventListener("message", async (event) => {
      const data = event.data;
      if (!data || !isMapInit) return;

      if (data.action === "initParentMap") {
        const myMarkers = data.myMarkers || [];
        
        // ðŸ”¥ STEP 1: Group students by distance
        const groups = groupStudents(myMarkers);
        
        // ðŸ”¥ STEP 2: Render the groups
        renderStudentMarkers(groups);

        recenterView(true); 
      }

      if (data.action === "updateBusLocation") {
        updateBusUI(data);
      }
    });
  </script>

  <script 
    src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCYaJ4Gjq36mq8swYgjNXOYr5mKZi45niA&libraries=marker,geometry&v=weekly&loading=async&callback=initMap" 
    async defer>
  </script>
</body>
</html>
