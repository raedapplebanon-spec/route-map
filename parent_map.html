<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <title>Parent Bus Map</title>
  
  <style>
    html, body { height: 100%; margin: 0; padding: 0; overflow: hidden; font-family: 'Segoe UI', Tahoma, sans-serif; }
    #map { height: 100%; width: 100%; }
    
    /* Clean, floating ETA Box (Optional) */
    .eta-box {
        display: none; 
        position: absolute; 
        top: 10px; 
        right: 10px; 
        background: white; 
        padding: 10px 15px; 
        border-radius: 8px; 
        box-shadow: 0 2px 6px rgba(0,0,0,0.3);
        z-index: 999;
        font-size: 14px;
        font-weight: bold;
        color: #333;
    }
  </style>

  <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCYaJ4Gjq36mq8swYgjNXOYr5mKZi45niA&callback=initMap&libraries=marker,geometry&loading=async&v=weekly" async defer></script>
</head>

<body>
  <div id="eta-box" class="eta-box">ÿ¨ÿßÿ±Ÿä ÿßŸÑÿßÿ™ÿµÿßŸÑ ÿ®ÿßŸÑÿ≠ÿßŸÅŸÑÿ©...</div>
  <div id="map"></div>

  <script>
    // --- Config ---
    const MY_MAP_ID = "48c2bb983bd19c1c44d95cb7";
    const BUS_ICON_URL = "https://raedapplebanon-spec.github.io/route-map/school-bus_6122028.png"; // Your Bus Icon
    const HOME_ICON_URL = "https://maps.google.com/mapfiles/ms/icons/blue-dot.png"; // Simple pin for the child

    // --- Globals ---
    let map, directionsService, directionsRenderer;
    let busMarker = null;
    let mapReady = false;
    let pendingData = null;

    // --- 1. Initialize Map ---
    window.initMap = async function() {
      try {
        const { Map } = await google.maps.importLibrary("maps");
        const { AdvancedMarkerElement, PinElement } = await google.maps.importLibrary("marker");

        map = new Map(document.getElementById("map"), {
          center: { lat: 33.8938, lng: 35.5018 }, // Default to Beirut
          zoom: 12,
          mapId: MY_MAP_ID,
          mapTypeControl: false,
          streetViewControl: false,
          fullscreenControl: false,
          zoomControl: true
        });

        directionsService = new google.maps.DirectionsService();
        directionsRenderer = new google.maps.DirectionsRenderer({
            map: map,
            suppressMarkers: true, // We draw our own custom pins
            preserveViewport: true,
            polylineOptions: { strokeColor: "#1a73e8", strokeOpacity: 0.7, strokeWeight: 5 }
        });

        mapReady = true;
        console.log("‚úÖ Parent Map Initialized");

        // Load pending data if Flutter sent it early
        if (pendingData) {
            window.setParentRoute(pendingData);
            pendingData = null;
        }

        // Notify Flutter we are ready
        sendToFlutter({ action: 'mapIsReady' });

      } catch (e) {
        console.error("‚ùå initMap Failed:", e);
      }
    };

    // --- 2. Listen for Flutter Messages ---
    window.addEventListener("message", function (event) {
      if (!event.data) return;
      let data = event.data;
      if (typeof data === 'string') { try { data = JSON.parse(data); } catch(e){} }

      // ACTION A: Load the Route (Blue Line + My Stop)
      if (data.action === "setParentRoute") {
          if (mapReady) window.setParentRoute(data.stops);
          else pendingData = data.stops;
      }

      // ACTION B: Move the Bus (Live)
      if (data.action === "updateBusLocation") {
          window.updateBusLocation(data.lat, data.lng);
      }
    });

    // --- 3. Draw Route & Markers ---
    window.setParentRoute = function(stops) {
        if (!stops || stops.length < 2) return;

        console.log("üìç Drawing Parent Route with " + stops.length + " stops.");

        // A. Draw the Blue Line (Using ALL stops for accuracy)
        calculateRouteLine(stops);

        // B. Draw Pins (ONLY for Start, End, and My Child)
        // Clear old markers if any (except the bus)
        if (window.myMarkers) {
            window.myMarkers.forEach(m => m.map = null);
        }
        window.myMarkers = [];

        stops.forEach(stop => {
            // Only draw if Flutter said 'isVisible: true'
            if (stop.isVisible) {
                createMarker(stop);
            }
        });
    };

    function createMarker(stop) {
        let pinBackground = "#1a73e8"; // Blue for Child
        let glyphText = "üè†"; 

        if (stop.type === 'school' || stop.isStart) {
            pinBackground = "#00c853"; // Green for Start
            glyphText = "S";
        } else if (stop.isEnd) {
            pinBackground = "#d50000"; // Red for End
            glyphText = "E";
        }

        const pin = new google.maps.marker.PinElement({
            background: pinBackground,
            borderColor: "#FFFFFF",
            glyphColor: "#FFFFFF",
            glyphText: glyphText,
            scale: 1.1
        });

        const marker = new google.maps.marker.AdvancedMarkerElement({
            map: map,
            position: { lat: stop.lat, lng: stop.lng },
            content: pin.element,
            title: stop.name
        });

        window.myMarkers.push(marker);
    }

    function calculateRouteLine(stops) {
        const start = stops[0];
        const end = stops[stops.length - 1];
        const waypoints = stops.slice(1, -1).map(s => ({
            location: { lat: s.lat, lng: s.lng },
            stopover: false // 'false' makes the line smoother/cheaper
        }));

        directionsService.route({
            origin: { lat: start.lat, lng: start.lng },
            destination: { lat: end.lat, lng: end.lng },
            waypoints: waypoints,
            travelMode: google.maps.TravelMode.DRIVING,
        }, (result, status) => {
            if (status === "OK") {
                directionsRenderer.setDirections(result);
                
                // Fit bounds to show the whole route initially
                const bounds = new google.maps.LatLngBounds();
                stops.forEach(s => bounds.extend({ lat: s.lat, lng: s.lng }));
                map.fitBounds(bounds);
                
            } else {
                console.warn("‚ùå Route draw failed:", status);
            }
        });
    }

    // --- 4. Live Bus Animation ---
    window.updateBusLocation = function(lat, lng) {
        const busPos = { lat: lat, lng: lng };
        
        document.getElementById("eta-box").style.display = "block";
        document.getElementById("eta-box").innerText = "üöç ÿßŸÑÿ≠ÿßŸÅŸÑÿ© ÿ™ÿ™ÿ≠ÿ±ŸÉ ÿßŸÑÿ¢ŸÜ";

        if (!busMarker) {
            // Create the Bus Icon if it doesn't exist
            const img = document.createElement("img");
            img.src = BUS_ICON_URL;
            img.style.width = "40px";
            img.style.height = "40px";

            busMarker = new google.maps.marker.AdvancedMarkerElement({
                map: map,
                position: busPos,
                content: img,
                title: "School Bus",
                zIndex: 999 // Always on top
            });
        } else {
            // Smoothly move the existing marker
            busMarker.position = busPos;
        }
    };

    function sendToFlutter(payload) {
        if (window.FlutterChan) window.FlutterChan.postMessage(JSON.stringify(payload));
        else window.parent.postMessage(payload, "*");
    }
  </script>
</body>
</html>
