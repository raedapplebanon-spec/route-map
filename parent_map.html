<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <title>Parent Tracking Map</title>
  <style>
    html, body, #map { height: 100%; margin: 0; padding: 0; font-family: 'Segoe UI', sans-serif; }
    
    /* ðŸ”¥ SMOOTH SLIDING CSS */
    .bus-marker-container {
      transition: all 1.5s linear; 
      pointer-events: none;
    }

    /* ðŸŽ¯ RECENTER BUTTON CSS */
    .custom-map-control {
      background-color: #fff;
      border: 0;
      border-radius: 8px;
      box-shadow: 0 2px 6px rgba(0,0,0,.3);
      cursor: pointer;
      margin: 10px;
      padding: 8px 12px;
      font-size: 14px;
      font-weight: bold;
      color: #1a73e8;
      display: flex;
      align-items: center;
      gap: 5px;
    }
    .custom-map-control:hover { background-color: #f8f9fa; }
  </style>
</head>
<body>

  <div id="map"></div>

  <script>
    let map;
    let busMarker;
    let studentMarkers = {};
    let isMapInit = false;
    let AdvancedMarkerElement, PinElement;
    
    // Track if the user has manually moved the map
    let isUserPanned = false;

    // --- 1. INITIALIZATION ---
    async function initMap() {
      try {
        const { Map } = await google.maps.importLibrary("maps");
        const markerLib = await google.maps.importLibrary("marker");
        AdvancedMarkerElement = markerLib.AdvancedMarkerElement;
        PinElement = markerLib.PinElement;

        map = new Map(document.getElementById("map"), {
          center: { lat: 33.8938, lng: 35.5018 },
          zoom: 15,
          mapId: "48c2bb983bd19c1c44d95cb7",
          disableDefaultUI: false, 
          mapTypeControl: true,
          zoomControl: true,
          streetViewControl: false,
          fullscreenControl: false
        });

        // Add the Recenter Button to the UI
        const recenterBtn = document.createElement("button");
        recenterBtn.innerHTML = "ðŸŽ¯ Ø¥Ø¹Ø§Ø¯Ø© Ø¶Ø¨Ø· Ø§Ù„Ø¹Ø±Ø¶";
        recenterBtn.classList.add("custom-map-control");
        recenterBtn.addEventListener("click", () => {
          isUserPanned = false;
          recenterView();
        });

        map.controls[google.maps.ControlPosition.RIGHT_BOTTOM].push(recenterBtn);

        // Detect if user starts dragging the map
        map.addListener("dragstart", () => { isUserPanned = true; });

        isMapInit = true;
        console.log("âœ… Parent Map Ready");

        // ðŸ”¥ NOTIFY FLUTTER: The map is ready to receive student pins now
        const readyPayload = { action: "mapIsReady" };
        if (window.chrome && window.chrome.webview) {
            window.chrome.webview.postMessage(readyPayload); // Mobile
        } else if (window.parent) {
            window.parent.postMessage(readyPayload, "*"); // Web
        }

      } catch (e) {
        console.error("âŒ Init Error: ", e);
      }
    }

    // --- 2. CAMERA/RECENTER LOGIC ---
    function recenterView() {
      if (!isMapInit) return;
      
      const bounds = new google.maps.LatLngBounds();
      let hasPoints = false;

      if (busMarker && busMarker.position) {
        bounds.extend(busMarker.position);
        hasPoints = true;
      }

      Object.values(studentMarkers).forEach(m => {
        bounds.extend(m.position);
        hasPoints = true;
      });

      if (hasPoints) {
        map.fitBounds(bounds, { padding: 100 });
      }
    }

    // --- 3. BRIDGE FUNCTION ---
    window.handleDirectUpdate = function(lat, lng) {
      updateBusUI({ lat: lat, lng: lng });
    };

    // --- 4. SHARED UI UPDATE LOGIC ---
    function updateBusUI(data) {
      if (!isMapInit) return;
      
      const lat = parseFloat(data.lat);
      const lng = parseFloat(data.lng);
      if (isNaN(lat) || isNaN(lng)) return;
      
      const busPos = { lat, lng };

      if (!busMarker) {
        const busPin = new PinElement({ background: "#FBBC04", glyphText: "ðŸšŒ" });
        const container = document.createElement('div');
        container.className = 'bus-marker-container';
        container.appendChild(busPin.element);

        busMarker = new AdvancedMarkerElement({
          map: map,
          position: busPos,
          content: container,
          zIndex: 1000
        });
      } else {
        busMarker.position = busPos;
      }

      // Only auto-fit if the user hasn't manually panned away
      if (!isUserPanned) {
        recenterView();
      }
    }

    // --- 5. MESSAGE LISTENERS ---
    window.addEventListener("message", async (event) => {
      const data = event.data;
      if (!data || !isMapInit) return;

      if (data.action === "initParentMap") {
        const myMarkers = data.myMarkers || [];

        myMarkers.forEach(m => {
          const pos = { lat: parseFloat(m.lat), lng: parseFloat(m.lng) };
          if (!studentMarkers[m.id]) {
            const pin = new PinElement({ background: "#00c853", glyphColor: "white" });
            studentMarkers[m.id] = new AdvancedMarkerElement({
              map: map,
              position: pos,
              content: pin.element,
              title: m.name
            });
          }
        });
        
        recenterView();
      }

      if (data.action === "updateBusLocation") {
        updateBusUI(data);
      }
    });
  </script>

  <script 
    src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCYaJ4Gjq36mq8swYgjNXOYr5mKZi45niA&libraries=marker,geometry&v=weekly&loading=async&callback=initMap" 
    async defer>
  </script>
</body>
</html>
